#!/bin/bash

main() {
  if [ -f 'src/.env.example' ]; then
    git pull

    if [ ! -f 'src/.env' ]; then
      echo '> No .env file found. Initialising repo.'
      generateEnvFile
      rm -rf node_modules && \
      bin/docker-dev build --pull && \
      installDependencies
    fi

    bin/docker-dev-up -d
    migrateDatabase

    local ipAddress=$(bin/docker-dev port nginx-proxy 443)
    bin/docker-dev exec web sed -i "/APP_HOST=.*/c\APP_HOST=${ipAddress}" src/.env

    open -a '/Applications/Google Chrome.app' https://${ipAddress}
    echo "> Site running in Chrome at URL: https://${ipAddress}"
  else
    echo 'ERROR: No .env.example file found.'
  fi

  exit 0
}

generateEnvFile() {
  echo 'APP_HOST=0.0.0.0' >> src/.env
  echo 'APP_IN_TEST_MODE=true' >> src/.env
  echo 'CACHE_DRIVER=array' >> src/.env
}

installDependencies() {
  composer install --ignore-platform-reqs
  yarn --frozen-lockfile
}

migrateDatabase() {
  bin/docker-dev run builder docker/wait-for-it.sh mysql:3306 -t 90
  bin/docker-dev-migrate
}

main "$@"
